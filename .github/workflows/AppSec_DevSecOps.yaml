name: Application Security Pipeline

on:
  push:
    branches: [main, master, develop, test, feature/*, hotfix/*]
  pull_request:
    branches: [main, master, develop]
  schedule:
    - cron: '0 2 * * 1'  # Haftalik otomatik tarama
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  issues: write
  pull-requests: write

env:
  IMAGE_NAME: juice-shop
  IMAGE_TAG: ${{ github.sha }}
  FAIL_ON_CRITICAL: true
  FAIL_ON_HIGH: true
  NODE_VERSION: '18'

jobs:
  # Secret ve credential taramasi
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    outputs:
      secrets_found: ${{ steps.gitleaks.outputs.exitcode }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: true
        continue-on-error: false

      - name: Upload Gitleaks results to Security Dashboard
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
          category: secret-scanning

      - name: Fail if secrets found
        if: steps.gitleaks.outputs.exitcode != '0'
        run: |
          echo "::error::CRITICAL: Secrets or credentials detected in code!"
          echo "::error::Pipeline durduruldu. Lutfen Security Dashboard'u kontrol edin."
          exit 1

  # Static kod analizi
  sast-codeql:
    name: SAST - CodeQL Analysis
    runs-on: ubuntu-latest
    needs: secret-scanning
    permissions:
      security-events: write
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  sast-semgrep:
    name: SAST - Semgrep Scan
    runs-on: ubuntu-latest
    needs: secret-scanning
    permissions:
      security-events: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep security scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >
            p/security-audit
            p/owasp-top-ten
            p/javascript
            p/nodejs
          generateSarif: true
        continue-on-error: true

      - name: Upload Semgrep results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep-sast

  # Dependency ve SCA taramasi
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    needs: secret-scanning
    permissions:
      security-events: write
      contents: read
    outputs:
      critical_vulns: ${{ steps.check_vulns.outputs.critical_count }}
      high_vulns: ${{ steps.check_vulns.outputs.high_count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci --ignore-scripts
        continue-on-error: true

      - name: Run NPM audit
        run: |
          npm audit --json > npm-audit.json || true
          npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          vuln-type: 'library'

      - name: Upload Trivy results to Security Dashboard
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: dependency-scan

      - name: Trivy JSON report for analysis
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-fs.json'
          severity: 'CRITICAL,HIGH'

      - name: Analyze vulnerability counts
        id: check_vulns
        run: |
          if [ -f trivy-fs.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-fs.json || echo 0)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-fs.json || echo 0)
            echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high_count=$HIGH" >> $GITHUB_OUTPUT
            echo "Critical vulnerabilities: $CRITICAL"
            echo "High vulnerabilities: $HIGH"
          fi

  # Container image security
  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: [sast-codeql, dependency-check]
    permissions:
      security-events: write
      contents: read
    outputs:
      container_critical: ${{ steps.analyze_container.outputs.critical }}
      container_high: ${{ steps.analyze_container.outputs.high }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ env.IMAGE_NAME }}:latest

      - name: Trivy container image scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: '${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}'
          format: 'sarif'
          output: 'trivy-image.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          vuln-type: 'os,library'

      - name: Upload Trivy image results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-image.sarif
          category: container-security

      - name: Trivy JSON report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: '${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}'
          format: 'json'
          output: 'trivy-image.json'
          severity: 'CRITICAL,HIGH'

      - name: Analyze container vulnerabilities
        id: analyze_container
        run: |
          if [ -f trivy-image.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-image.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-image.json)
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "Container critical vulnerabilities: $CRITICAL"
            echo "Container high vulnerabilities: $HIGH"
          fi

      - name: Hadolint - Dockerfile linting
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: sarif
          output-file: hadolint.sarif
          no-fail: true

      - name: Upload Hadolint results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint.sarif
          category: dockerfile-lint

  # Security quality gate - kritik bulgularda pipeline'i durdur
  security-gate:
    name: Security Quality Gate
    runs-on: ubuntu-latest
    needs: [secret-scanning, sast-codeql, sast-semgrep, dependency-check, container-security]
    if: always()
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Evaluate security posture
        id: evaluate
        run: |
          echo "Security Scan Summary"
          echo "====================="
          echo "Secret Scanning: ${{ needs.secret-scanning.result }}"
          echo "SAST CodeQL: ${{ needs.sast-codeql.result }}"
          echo "SAST Semgrep: ${{ needs.sast-semgrep.result }}"
          echo "Dependency Check: ${{ needs.dependency-check.result }}"
          echo "Container Security: ${{ needs.container-security.result }}"
          echo ""
          
          FAILED=0
          
          # Secret kontrolu
          if [ "${{ needs.secret-scanning.result }}" == "failure" ]; then
            echo "CRITICAL: Secrets detected in repository!"
            FAILED=1
          fi
          
          # Dependency zafiyetleri
          CRITICAL_DEPS="${{ needs.dependency-check.outputs.critical_vulns }}"
          HIGH_DEPS="${{ needs.dependency-check.outputs.high_vulns }}"
          
          if [ ! -z "$CRITICAL_DEPS" ] && [ "$CRITICAL_DEPS" -gt 0 ]; then
            echo "CRITICAL: $CRITICAL_DEPS adet critical zafiyet bulundu (dependencies)!"
            if [ "${{ env.FAIL_ON_CRITICAL }}" == "true" ]; then
              FAILED=1
            fi
          fi
          
          if [ ! -z "$HIGH_DEPS" ] && [ "$HIGH_DEPS" -gt 10 ]; then
            echo "WARNING: $HIGH_DEPS adet high zafiyet bulundu!"
            if [ "${{ env.FAIL_ON_HIGH }}" == "true" ]; then
              FAILED=1
            fi
          fi
          
          # Container zafiyetleri
          CRITICAL_CONTAINER="${{ needs.container-security.outputs.container_critical }}"
          
          if [ ! -z "$CRITICAL_CONTAINER" ] && [ "$CRITICAL_CONTAINER" -gt 0 ]; then
            echo "CRITICAL: $CRITICAL_CONTAINER adet critical zafiyet bulundu (container)!"
            if [ "${{ env.FAIL_ON_CRITICAL }}" == "true" ]; then
              FAILED=1
            fi
          fi
          
          echo "gate_status=$FAILED" >> $GITHUB_OUTPUT

      - name: Create security report comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `## Security Scan Results
            
            | Scan Type | Status |
            |-----------|--------|
            | Secret Scanning | ${{ needs.secret-scanning.result }} |
            | SAST - CodeQL | ${{ needs.sast-codeql.result }} |
            | SAST - Semgrep | ${{ needs.sast-semgrep.result }} |
            | Dependency Check | ${{ needs.dependency-check.result }} |
            | Container Security | ${{ needs.container-security.result }} |
            
            ### Zafiyet Ozeti
            - **Critical Dependencies**: ${{ needs.dependency-check.outputs.critical_vulns || 'N/A' }}
            - **High Dependencies**: ${{ needs.dependency-check.outputs.high_vulns || 'N/A' }}
            - **Critical Container**: ${{ needs.container-security.outputs.container_critical || 'N/A' }}
            - **High Container**: ${{ needs.container-security.outputs.container_high || 'N/A' }}
            
            ### Links
            - [Security Dashboard](https://github.com/${{ github.repository }}/security)
            - [Code Scanning Alerts](https://github.com/${{ github.repository }}/security/code-scanning)
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail pipeline if critical issues found
        if: steps.evaluate.outputs.gate_status == '1'
        run: |
          echo "::error::SECURITY GATE FAILED!"
          echo "::error::Kritik guvenlik sorunlari tespit edildi."
          echo "::error::Detaylar icin: https://github.com/${{ github.repository }}/security"
          echo ""
          echo "Yapilmasi gerekenler:"
          echo "1. Security Dashboard'u kontrol et"
          echo "2. Critical/High zafiyetleri duzelt"
          echo "3. Exposed secret'lari kaldir"
          echo "4. Pipeline'i tekrar calistir"
          exit 1

      - name: Security gate passed
        if: steps.evaluate.outputs.gate_status == '0'
        run: |
          echo "Security Quality Gate PASSED"
          echo "Tum guvenlik kontrolleri basarili."
          echo "Detaylar: https://github.com/${{ github.repository }}/security"
